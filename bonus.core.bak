<?xml version="1.0" encoding="UTF-8"?>

<!-- This file contains the definitions of elements associated with background bonuses / penalties.
-->

<document signature="Hero Lab Structure">

  <!-- Bonus group - tags used to manage bonuses
  -->
  <group
    id="BGBonus">
    <value id="Gizmo"/>       <!-- Used on the gizmo that represents each bonus-->
    <value id="MustChoose"/>  <!-- Used to require selection of an attribute, skill, etc. -->
    <value id="Newest"/>      <!-- Identifies the most recent bonus on character -->
    <value id="Increase"/>    <!-- Bonus increases the value of the associated trait -->
    <value id="Decrease"/>    <!-- Bonus decreases the value of the associated trait -->
    <value id="AddNew"/>      <!-- Bonus adds a new trait to the character -->
    <value id="Notation"/>    <!-- Bonus provides place for a notation by the user (like a domain) -->
    </group>
  
  <!-- Bonus component
        Each bonus derives from this component
        NOTE! Bonus picks utilize "unwind" logic based on the "IsBonus" identity
                tag assigned by the child pick.
  -->
  <component
    id="BGBonus"
    name="BG Bonus"
    orderfield="bonOrder"
    autocompset="no">

    <!-- Dynamic tagexpr for selecting what to improve -->
    <field
      id="bonDynamic"
      name="Dynamic TagExpr"
      type="derived"
      maxlength="3000">
      </field>

    <!-- Action associated with this bonus entry -->
    <field
      id="bonAction"
      name="Action"
      type="derived"
      maxlength="25">
      </field>

    <!-- Bonuss need an identity tag so we can identify specific ones during validation -->
    <identity group="BonusId"/>

    <!-- Use a custom width for showing bonuses for selection with the LargeItem template -->
    <tag group="SimpleItem" tag="width225"/>

    <!-- Put the dynamic tagexpr for choosers into the child gizmo -->
    <eval index="1" phase="Render" priority="2000" name="Assign Dynamic Tagexpr"><![CDATA[
      if (empty(field[bonDynamic].text) = 0) then
	      debug "bonTagexpr: " &  field[bonDynamic].text & " & !thing.showonly"
	      gizmo.child[bonDetails].field[bonTagexpr].text = field[bonDynamic].text & " & !thing.showonly"
        endif
      ]]></eval>

    <!-- Synthesize an appropriate name for the bonus -->
    <eval index="2" phase="Final" priority="10000"><![CDATA[
      ~if this bonus has an annotation, there is no user-selection, so build
      ~the name from our pieces and we're done
      if (tagis[Bonus.Notation] <> 0) then
        perform gizmo.child[bonDetails].setfocus
        field[livename].text = field[name].text & ": " & focus.field[bonUser].text
        done
        endif

      ~start with the name of the selected bonus
      field[livename].text = gizmo.findchild[none,"Bonus.Gizmo"].field[name].text

      ~determine the user-selected child associated with this bonus
      ~Note: If the user hasn't selected anything yet, we won't have one, so we need
      ~       to bail out at this point if we don't have one yet.
      perform gizmo.findchild[none,"Bonus.Gizmo"].setfocus
      doneif (state.isfocus = 0)

      ~if we have a domain, append it to our name
      ~Note: If this is a boost, we need to get the domain from the basis linkage.
      if (focus.tagis[User.NeedDomain] <> 0) then
        if (tagis[Bonus.AddNew] <> 0) then
          field[livename].text &= ": " & focus.field[domDomain].text
        else
          field[livename].text &= ": " & focus.linkage[basis].field[domDomain].text
          endif
        endif
      ]]></eval>

    </component>


  <!-- BonDetails component - bonus details living within each gizmo
  -->
  <component
    id="BonDetails"
    name="Bonus Details"
    ispublic="no">

    <!-- Target of bonus (specific attribute, skill, etc. that is improved) -->
    <field
      id="bonTarget"
      name="Target"
      type="user">
      </field>

    <!-- Real world date when the improvement is performed -->
    <field
      id="bonReal"
      name="Real World Date"
      type="user">
      </field>

    <!-- Game world date when the improvement is performed -->
    <field
      id="bonGame"
      name="Game World Date"
      type="user">
      </field>

    <!-- User notes regarding the improvement -->
    <field
      id="bonNotes"
      name="User Notes"
      type="user"
      maxlength="500">
      </field>

    <!-- Dynamic tagexpr for selecting what to improve -->
    <field
      id="bonTagexpr"
      name="Dynamic TagExpr"
      type="derived"
      maxlength="1000">
      </field>

    <!-- User-assigned text (required here so bonus form can capture text and forward it to actual trait) -->
    <field
      id="bonUser"
      name="User Text"
      type="user"
      maxlength="100">
      </field>

    <!-- Initialize the real world date appropriately -->
    <creation>
      field[bonReal].value = today()
      </creation>

    <!-- If we have user text, forward it to the associated object
        NOTE! This must be done BEFORE anything tries to access the domain text for use.
        -->
    <eval index="1" phase="Setup" priority="100"><![CDATA[
      if (field[bonUser].isempty = 0) then
        trustme
        container.findchild[none,"Bonus.Gizmo"].field[domDomain].text = field[bonUser].text
        endif
      ]]></eval>

    </component>


  <!-- Define various component sets associated with the components defined above.
  -->

  <!-- The "CanBonus" compset is auto-defined for the component -->


  <!-- Bonus - all bonuses utilize this compset -->
  <compset
    id="BGBonus">
    <compref component="BGBonus"/>
    </compset>


  <!-- Define any entities associated with the components defined above.
  -->


  <!-- Bonus Encapsulation -->
  <entity
    id="BGBonus"
    form="bonusgiz">
    <bootstrap thing="bonDetails"/>
    <integrity><![CDATA[
      var bullet as string
      bullet = "{bmp bullet_red}{horz 4}"
      @message = ""

      ~verify that a chooser selection is made if one is required
      if (parent.tagis[Bonus.MustChoose] + parent.tagis[Bonus.AddNew] >= 2) then
        if (findchild[none,"Bonus.Gizmo"].tagis[Bonus.Gizmo] = 0) then
          @message &= bullet & "A specific trait/ability must be selected via the chooser.{br}"
          endif
        endif

      ~verify that we've been given a domain if one is required
      if (parent.tagis[Bonus.MustChoose] + parent.tagis[Bonus.AddNew] >= 2) then
        if (findchild[none,"Bonus.Gizmo"].tagis[User.NeedDomain] <> 0) then
          if (empty(child[bonDetails].field[bonUser].text) <> 0) then
            @message &= bullet & "The selection requires that you specify an appropriate domain.{br}"
            endif
          endif
        endif
      ]]></integrity>
    </entity>


  </document>
