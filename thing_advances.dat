<?xml version="1.0" encoding="UTF-8"?>

<!-- This file contains the assortment of advances that can be selected by actors as
      their experience accrues.
-->

<document signature="Hero Lab Data">


  <!-- Advancement Details - shared by all advancements
  -->
  <thing
    id="advDetails"
    name="Advancement Details"
    compset="AdvDetails">
    </thing>


  <!-- Increase Skill advance
  -->
  <thing
    id="advSkill"
    name="Increase Skills"
    compset="Advance"
    description="Select three skills to increase by one.">
    <fieldval field="advAction" value="Increase Skill"/>
    <fieldval field="advDynamic" value="component.Skill &amp; !Hide.Skill"/>
    <tag group="Advance" tag="Increase"/>

    <eval value="1" phase="Final" priority="1001">
      <![CDATA[
        var skills as string
        
        foreach pick in gizmo from Skill
          skills &= " & !Skill." & eachpick.idstring
          nexteach
        field[advDynamic].text &= skills
        ]]>
      </eval>
    
    <!-- Attach the child entity for tracking the advance -->
    <child entity="Advance">
      <tag group="Advance" tag="MustChoose"/>
      </child>
    </thing>

  <!-- Add Specialty advance -->
  <thing
    id="advSpec"
    name="Add Specialty"
    compset="Advance"
    description="Add a skill specialty">
    <fieldval field="advAction" value="Add Specialty"/>
    <fieldval field="advDynamic" value="component.Specialty &amp; !Hide.Specialty"/>
    <tag group="Advance" tag="AddNew"/>
    <eval value="1" phase="Render" priority="1000">
      <before name="Assign Dynamic Tagexpr"/><![CDATA[
      ~get the list of all unique specialties on the hero and assemble it as a list of precluded tags
      var tagexpr as string
      foreach pick in hero where "component.Skill"
        var skillID as string
        var skillrank as number
        var speccount as number
        skillID = eachpick.idstring
        skillrank = eachpick.field[trtFinal].value
        speccount = eachpick.tagcount[User.HasSpec]
        
        if (speccount < skillrank) then
          foreach pick in eachpick.gizmo where "component.Specialty & !Hide.Specialty"
            if (each.isunique <> 0) then
              tagexpr &= " & !Specialty." & each.idstring
            endif
          nexteach
        else
          tagexpr &= " & !Skill." & skillID
        endif
      nexteach
      
      ~if there are any tags to exclude, append them to the tagexpr appropriately
      if (empty(tagexpr) = 0) then
        field[advDynamic].text &= tagexpr
        ~ debug "advDynamic: " & field[advDynamic].text
        endif
      ]]></eval>
<child entity="Advance">
<tag group="Advance" tag="MustChoose"/>
</child></thing>
  
  </document>
